# C ノードネットワーク

これはCで実装されたP2Pノードネットワークで、複数のノードがそれぞれのノードIDを使って互いに通信することができます。NAT越えの機能を備えており、異なるネットワーク上のコンピュータ間でも自動的に通信が可能です。Linux、macOS、Windowsで動作します。

## 特徴

- 最大100個のノードを作成し、それぞれに一意のIDを割り当て
- 各ノードは独自のスレッドで実行
- ノードは受信者のIDを使用して他のノードにメッセージを送信可能
- メッセージには送信者ID、受信者ID、メッセージデータが含まれる
- すべてのノードはメッシュネットワークで相互に接続
- **NAT越え機能によりインターネット越しの通信が可能（デフォルトで有効）**
- **自動ピア発見機能によりネットワーク上の他のノードを自動的に検出（デフォルトで有効）**
- **UPnPによるポート転送の自動設定（デフォルトで有効）**
- **ファイアウォール対策機能により一般的に許可されているポートを使用**
- **接続の信頼性向上のための自動再接続機能**
- **簡易的なメッセージ認証機能**
- **ネットワーク診断機能によるトラブルシューティング**
- **対話的なコマンドラインインターフェース**

## 実装の詳細

- 通信にUDPソケットを使用
- 各ノードは異なるポート（BASE_PORT + node_id）でリッスン
- メッセージは一つのノードから別のノードに直接送信
- スレッドを使用して非同期でメッセージを受信
- STUNサーバーを使用してNAT越えを実現
- UPnPを使用してルーターのポート転送を自動設定
- マルチキャストを使用したピア発見
- ピア情報の共有によるネットワークの拡大
- 定期的なキープアライブメッセージによる接続維持
- 複数のポートを試行するファイアウォール対策
- 簡易的なHMACによるメッセージ認証

## ビルドと実行方法

### Linux/macOS

プロジェクトをビルドするには：

```bash
make
```

ネットワークを実行するには：

```bash
./node_network [オプション]
```

### macOS特有の注意点

macOSでビルドする場合、Makefileは自動的にmacOS用の設定を使用します。もし問題が発生した場合は以下を確認してください：

1. Xcodeコマンドラインツールがインストールされていることを確認：
   ```bash
   xcode-select --install
   ```

2. Makefileのインデントがタブ文字であることを確認（スペースではなく）：
   ```bash
   cat -e -t -v Makefile
   ```
   タブ文字は`^I`と表示されます。スペースの場合は修正が必要です。

### Windows

Windows上では、WSL（Windows Subsystem for Linux）またはMinGWを使用してビルドできます：

#### WSLを使用する場合：
1. WSLをインストール
2. Linuxディストリビューション（Ubuntu推奨）をインストール
3. WSL内で以下を実行：
   ```bash
   sudo apt update
   sudo apt install build-essential
   make
   ```

#### MinGWを使用する場合：
1. MinGWをインストール
2. コマンドプロンプトで以下を実行：
   ```
   mingw32-make
   ```

オプション：
- `-n COUNT` - 作成するノードの数（デフォルト：5）
- `-T` - NAT越え機能を無効化（デフォルトでは有効）
- `-U` - UPnPポート転送を無効化（デフォルトでは有効）
- `-D` - 自動ピア発見を無効化（デフォルトでは有効）
- `-E` - 拡張ピア発見を無効化（デフォルトでは有効）
- `-S` - ディスカバリーサーバーを無効化（デフォルトでは無効）
- `-F` - ファイアウォール対策モードを無効化（デフォルトでは有効）
- `-s SERVER` - 使用するSTUNサーバー（デフォルト：stun.l.google.com）
- `-d SERVER:PORT` - 使用するディスカバリーサーバー
- `-p PEER` - リモートピアを追加（形式：id:ip:port）
- `-h` - ヘルプメッセージを表示

プログラムは以下を行います：
1. 指定された数のノードを作成
2. NAT越え機能が有効な場合、公開IPアドレスとポートを検出
3. UPnPが有効な場合、ルーターのポート転送を設定
4. 自動ピア発見が有効な場合、ネットワーク上の他のノードを検出
5. 各ノードが他のすべてのノードにメッセージを送信するデモを実行
6. 対話的なコマンドラインインターフェースを提供
7. 中断（Ctrl+C）されるまで実行を継続

## 対話的なコマンド

プログラム実行中に以下のコマンドを使用できます：

- `status` - すべてのノードの状態を表示
- `list` または `nodes` - すべてのノードとピアを一覧表示
- `ping <id>` - 特定のノードにpingを送信
- `send <id> <message>` - 特定のノードにメッセージを送信
  - 例: `send 0 こんにちは！これはテストメッセージです`
- `diag` または `diagnostics` - ネットワーク診断を実行
- `help` - ヘルプメッセージを表示
- `exit` または `quit` - プログラムを終了

### メッセージの送受信例

1. ノードを起動します：
   ```bash
   ./node_network
   ```

2. 別のコンピュータでノードを起動します（同じネットワーク上なら自動的に発見されます）

3. `list` コマンドを使用して、接続されているノードを確認します：
   ```
   list
   ```

4. 特定のノードにメッセージを送信します：
   ```
   send 0 こんにちは！これはテストメッセージです
   ```

5. メッセージが送信されると、送信側と受信側の両方に通知が表示されます

## 異なるコンピュータ間での通信

異なるコンピュータ間で通信するには、以下の手順に従います：

### 同じローカルネットワーク上での通信（最も簡単）

拡張ピア発見機能を使用すると、同じローカルネットワーク上のノードを自動的に発見できます：

1. 各コンピュータでプログラムをビルド
2. 最初のコンピュータでノードを起動：`./node_network -n 5`
3. 2台目のコンピュータでノードを起動：`./node_network -n 5`

同じローカルネットワーク上にある場合、ノードは自動的に互いを発見して接続します。拡張ピア発見機能は、マルチキャストを使用して同じネットワーク上の他のノードを自動的に発見します。

### インターネット越しの通信（NAT越え）

異なるネットワーク上のコンピュータ間で通信する場合：

1. 各コンピュータでプログラムをビルド
2. 最初のコンピュータでノードを起動：`./node_network -n 5`
3. 最初のコンピュータの公開IPアドレスとポートをメモ（出力に表示されます）
4. 2台目のコンピュータでノードを起動：`./node_network -n 5 -p 0:公開IP:公開ポート`

最初のノードの情報を入力すると、そのノードに接続し、そのノードが知っている他のノードの情報も自動的に共有されます。

### macOSとLinux/Windowsの間での通信

異なるOS間でも同様に通信できます：

1. macOSで実行：`./node_network -n 5`
2. 表示された接続情報をメモ（例：`Node 0 created and listening on 192.168.1.100:8000`）
3. Linux/Windowsで実行：`./node_network -n 5 -p 0:192.168.1.100:8000`

または逆も同様です。

### ファイアウォールがある場合

ファイアウォール対策モードはデフォルトで有効になっています。これにより、一般的に許可されているポート（80, 443など）を使用してファイアウォールを通過します。

無効にする場合は、`-F`オプションを使用します：

```bash
./node_network -n 5 -F
```

## コード構造

- `node.h/node.c` - ノード関数（作成、破棄、接続、送信、受信）の実装
- `stun.h/stun.c` - STUNクライアントの実装（NAT越え用）
- `upnp.h/upnp.c` - UPnPクライアントの実装（ポート転送用）
- `discovery.h/discovery.c` - 基本的なピア発見機能の実装
- `enhanced_discovery.h/enhanced_discovery.c` - 拡張ピア発見機能の実装（マルチキャスト使用）
- `discovery_server.h/discovery_server.c` - ディスカバリーサーバークライアントの実装
- `nat_traversal.c` - NAT越え関連の機能の実装
- `firewall.h/firewall.c` - ファイアウォール対策機能の実装
- `reliability.h/reliability.c` - 接続の信頼性向上機能の実装
- `security.h/security.c` - メッセージ認証機能の実装
- `diagnostics.h/diagnostics.c` - ネットワーク診断機能の実装
- `main.c` - ネットワークをセットアップしメッセージングをデモするメインプログラム
- `Makefile` - ビルド設定

## トラブルシューティング

### macOSでのビルドエラー

macOSでビルド時に以下のようなエラーが発生した場合：

```
Makefile:12: *** missing separator (did you mean TAB instead of 8 spaces?).  Stop.
```

これはMakefileのインデントがスペースになっている場合に発生します。以下の手順で修正してください：

1. テキストエディタでMakefileを開く
2. すべてのインデント（行頭のスペース）をタブ文字に置き換える
3. 保存して再度makeを実行

### ノードが自動的に発見されない場合

1. ファイアウォールの設定を確認する
   - UDPポート8000-8100、8889（拡張ピア発見用）が許可されていることを確認
   - マルチキャストが許可されていることを確認

2. 同じネットワークセグメント上にあることを確認する
   - 異なるサブネットにある場合、マルチキャストが届かない可能性があります
   - その場合は `-p` オプションを使用して手動で接続してください

3. 明示的に接続する
   ```
   ./node_network -p 0:相手のIP:相手のポート
   ```

## プロジェクトの拡張

この実装は以下のようにさまざまな方法で拡張できます：
- より複雑なネットワークトポロジのためのルーティング機能の追加
- 完全な信頼性メカニズム（確認応答、再送信）の実装
- 強力な暗号化の追加（OpenSSLなどを使用）
- 分散ハッシュテーブル（DHT）の実装
- アプリケーション固有のメッセージタイプとハンドラの追加
- WebRTCのようなより高度なNAT越え技術の実装
- GUIの追加