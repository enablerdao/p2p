# 🌐 QuiC P2P ノードネットワーク

[![macOS Build and Test](https://github.com/enablerdao/p2p/actions/workflows/macos-build.yml/badge.svg)](https://github.com/enablerdao/p2p/actions/workflows/macos-build.yml)
[![Linux Build and Test](https://github.com/enablerdao/p2p/actions/workflows/linux-build.yml/badge.svg)](https://github.com/enablerdao/p2p/actions/workflows/linux-build.yml)

QuiC P2Pは、Cで実装された軽量で高速なピアツーピアネットワークライブラリです。複数のノードがノードIDを使って互いに直接通信できる分散型ネットワークを簡単に構築できます。NAT越え機能を備えており、異なるネットワーク上のコンピュータ間でも自動的に通信が可能です。

## 📋 目次

- [特徴](#特徴)
- [クイックスタート](#クイックスタート)
- [ビルドと実行方法](#ビルドと実行方法)
- [対話的なコマンド](#対話的なコマンド)
- [異なるコンピュータ間での通信](#異なるコンピュータ間での通信)
- [トラブルシューティング](#トラブルシューティング)
- [コード構造](#コード構造)
- [プロジェクトの拡張](#プロジェクトの拡張)

## ✨ 特徴

- 🔌 **プラグアンドプレイ**: 最大100個のノードを作成し、それぞれに一意のIDを割り当て
- 🧵 **マルチスレッド**: 各ノードは独自のスレッドで並行実行
- 📨 **IDベースメッセージング**: ノードIDを使用して他のノードにメッセージを直接送信
- 🕸️ **メッシュネットワーク**: すべてのノードが相互に接続可能
- 🌍 **NAT越え**: STUNサーバーを使用してインターネット越しの通信が可能
- 🔍 **自動ピア発見**: マルチキャストを使用して同じネットワーク上の他のノードを自動的に発見
- 🚪 **UPnP対応**: ルーターのポート転送を自動設定
- 🔥 **ファイアウォール対策**: 一般的に許可されているポートを使用して接続を確立
- 💓 **接続維持**: 定期的なキープアライブと自動再接続機能
- 🔒 **セキュリティ**: 簡易的なHMACによるメッセージ認証
- 🔧 **診断機能**: ネットワーク問題のトラブルシューティング
- 💻 **対話的CLI**: 使いやすいコマンドラインインターフェース

## 🚀 クイックスタート

macOSでQuiC P2Pを素早く始めるには：

```bash
# リポジトリをクローン
git clone https://github.com/enablerdao/p2p.git
cd p2p

# ビルド
make

# 5つのノードを起動
./node_network -n 5
```

## 🛠️ ビルドと実行方法

### macOS

macOSでは以下の手順でビルドと実行ができます：

```bash
# 必要なツールのインストール（初回のみ）
xcode-select --install

# ビルド
make

# 実行（5つのノードを起動）
./node_network -n 5
```

#### macOSでの注意点

- **Xcodeコマンドラインツール**: 上記の`xcode-select --install`コマンドでインストールできます
- **Makefileの問題**: エラーが発生した場合、Makefileのインデントがタブ文字であることを確認してください
  ```bash
  cat -e -t -v Makefile
  ```
  タブ文字は`^I`と表示されます。スペースの場合は修正が必要です。

### Linux

```bash
# 必要なパッケージのインストール
sudo apt update
sudo apt install build-essential

# ビルド
make

# 実行
./node_network -n 5
```

### Windows

Windows上では、WSL（Windows Subsystem for Linux）またはMinGWを使用できます：

#### WSLを使用する場合：
```bash
# WSLのインストール（PowerShellで実行）
wsl --install

# Ubuntu内で実行
sudo apt update
sudo apt install build-essential
make
./node_network -n 5
```

#### MinGWを使用する場合：
```bash
# MinGWでビルド
mingw32-make

# 実行
node_network.exe -n 5
```

オプション：
- `-n COUNT` - 作成するノードの数（デフォルト：5）
- `-T` - NAT越え機能を無効化（デフォルトでは有効）
- `-U` - UPnPポート転送を無効化（デフォルトでは有効）
- `-D` - 自動ピア発見を無効化（デフォルトでは有効）
- `-E` - 拡張ピア発見を無効化（デフォルトでは有効）
- `-S` - ディスカバリーサーバーを無効化（デフォルトでは無効）
- `-F` - ファイアウォール対策モードを無効化（デフォルトでは有効）
- `-s SERVER` - 使用するSTUNサーバー（デフォルト：stun.l.google.com）
- `-d SERVER:PORT` - 使用するディスカバリーサーバー
- `-p PEER` - リモートピアを追加（形式：id:ip:port）
- `-h` - ヘルプメッセージを表示

プログラムは以下を行います：
1. 指定された数のノードを作成
2. NAT越え機能が有効な場合、公開IPアドレスとポートを検出
3. UPnPが有効な場合、ルーターのポート転送を設定
4. 自動ピア発見が有効な場合、ネットワーク上の他のノードを検出
5. 各ノードが他のすべてのノードにメッセージを送信するデモを実行
6. 対話的なコマンドラインインターフェースを提供
7. 中断（Ctrl+C）されるまで実行を継続

## 💬 対話的なコマンド

プログラム実行中に以下のコマンドを使用できます：

| コマンド | 説明 | 例 |
|---------|------|-----|
| `status` | すべてのノードの状態を表示 | `status` |
| `list` または `nodes` | すべてのノードとピアを一覧表示 | `list` |
| `ping <id>` | 特定のノードにpingを送信 | `ping 2` |
| `send <id> <message>` | 特定のノードにメッセージを送信 | `send 0 こんにちは！` |
| `diag` | ネットワーク診断を実行 | `diag` |
| `help` | ヘルプメッセージを表示 | `help` |
| `exit` または `quit` | プログラムを終了 | `exit` |

### 🚀 メッセージの送受信例

1. ノードを起動します：
   ```bash
   ./node_network -n 5
   ```

2. 起動後、`list` コマンドを使用して接続されているノードを確認します：
   ```
   list
   ```

3. 特定のノードにメッセージを送信します：
   ```
   send 2 こんにちは！これはQuiCを使ったP2Pメッセージングのテストです。
   ```

4. メッセージが送信されると、送信側と受信側の両方に通知が表示されます：
   ```
   ┌─────────────────────────────────────────────────────┐
   │ MESSAGE SENT                                        │
   ├─────────────────────────────────────────────────────┤
   │ From:    Node 0                                    │
   │ To:      Node 2 at 192.168.0.194:8002                │
   │ Content: こんにちは！これはQuiCを使ったP2Pメッセージングのテストです。
   └─────────────────────────────────────────────────────┘
   ```

5. 別のノードからも送信してみましょう：
   ```
   send 0 こんにちは、Node 0！こちらはNode 2からの返信です。
   ```

## 🌐 異なるコンピュータ間での通信

### 📡 同じローカルネットワーク上での通信（最も簡単）

拡張ピア発見機能により、同じネットワーク上のノードを自動的に発見できます：

```bash
# コンピュータA
./node_network -n 5

# コンピュータB
./node_network -n 5
```

同じローカルネットワーク上にある場合、ノードは自動的に互いを発見して接続します。マルチキャストを使用して他のノードを検出します。

### 🌍 インターネット越しの通信（NAT越え）

異なるネットワーク上のコンピュータ間で通信する場合：

```bash
# コンピュータA
./node_network -n 5
# 出力から公開IPとポートをメモ: 例 "Public address: 203.0.113.42:12345"

# コンピュータB
./node_network -n 5 -p 0:203.0.113.42:12345
```

最初のノードの情報を入力すると、そのノードに接続し、そのノードが知っている他のノードの情報も自動的に共有されます。

### 🍎 macOSとLinux/Windowsの間での通信

異なるOS間でも同様に通信できます：

```bash
# macOS
./node_network -n 5
# 出力から接続情報をメモ: 例 "Node 0 created and listening on 192.168.1.100:8000"

# Linux/Windows
./node_network -n 5 -p 0:192.168.1.100:8000
```

### 📱 モバイルデバイスとの接続

将来的にはモバイルデバイスとの接続も可能になる予定です。現在はデスクトップ環境での使用をサポートしています。

### 🔥 ファイアウォール対策

ファイアウォール対策モードはデフォルトで有効になっています。これにより、一般的に許可されているポート（80, 443など）を使用してファイアウォールを通過します。

無効にする場合は、`-F`オプションを使用します：

```bash
./node_network -n 5 -F
```

## 🧩 コード構造

| ファイル | 説明 |
|---------|------|
| `node.h/node.c` | ノード関数（作成、接続、送信、受信）の実装 |
| `stun.h/stun.c` | STUNクライアント（NAT越え用） |
| `upnp.h/upnp.c` | UPnPクライアント（ポート転送用） |
| `discovery.h/discovery.c` | 基本的なピア発見機能 |
| `enhanced_discovery.h/enhanced_discovery.c` | 拡張ピア発見機能（マルチキャスト使用） |
| `discovery_server.h/discovery_server.c` | ディスカバリーサーバークライアント |
| `nat_traversal.c` | NAT越え関連の機能 |
| `firewall.h/firewall.c` | ファイアウォール対策機能 |
| `reliability.h/reliability.c` | 接続の信頼性向上機能 |
| `security.h/security.c` | メッセージ認証機能 |
| `diagnostics.h/diagnostics.c` | ネットワーク診断機能 |
| `main.c` | メインプログラム（ネットワーク初期化、CLI） |
| `Makefile` | ビルド設定 |

## 🔧 トラブルシューティング

### macOSでの問題解決

#### ビルドエラー

```
Makefile:12: *** missing separator (did you mean TAB instead of 8 spaces?).  Stop.
```

**解決方法**:
1. テキストエディタでMakefileを開く
2. すべてのインデント（行頭のスペース）をタブ文字に置き換える
   ```bash
   # タブ文字を確認
   cat -e -t -v Makefile
   
   # または一行で修正
   sed -i '' 's/^        /\t/g' Makefile
   ```
3. 保存して再度makeを実行

#### 「Bad file descriptor」エラー

```
Error receiving discovery message: Bad file descriptor
```

**解決方法**:
- これは通常の動作で、プログラムは自動的に回復します
- マルチキャストソケットの問題ですが、自動修復機能が組み込まれています

### ノードが自動的に発見されない場合

1. **ファイアウォール設定を確認**:
   - UDPポート8000-8100、8889（拡張ピア発見用）が許可されていることを確認
   - マルチキャストトラフィック（239.255.255.251）が許可されていることを確認

2. **ネットワーク設定を確認**:
   - 同じサブネット上にあることを確認（異なるサブネットではマルチキャストが届かない）
   - VPNを使用している場合は無効にしてみる

3. **手動で接続**:
   ```bash
   # 相手のIPとポートを指定して明示的に接続
   ./node_network -p 0:192.168.1.100:8000
   ```

## 🚀 プロジェクトの拡張

QuiC P2Pは拡張性を考慮して設計されています。以下のような機能を追加することができます：

| 拡張機能 | 説明 |
|---------|------|
| 🌐 **ルーティング** | より複雑なネットワークトポロジのためのルーティング機能 |
| 🔄 **信頼性向上** | 確認応答と再送信による完全な信頼性メカニズム |
| 🔐 **暗号化** | OpenSSLなどを使用した強力な暗号化 |
| 📊 **DHT** | 分散ハッシュテーブルによるスケーラブルなデータ管理 |
| 📦 **カスタムメッセージ** | アプリケーション固有のメッセージタイプとハンドラ |
| 🌟 **WebRTC連携** | より高度なNAT越え技術の実装 |
| 🖥️ **GUI** | グラフィカルユーザーインターフェース |
| 📱 **モバイル対応** | iOS/Androidライブラリの提供 |

## 📜 ライセンス

このプロジェクトはMITライセンスの下で公開されています。詳細はLICENSEファイルを参照してください。

## 👥 コントリビューション

バグ報告、機能リクエスト、プルリクエストなど、あらゆる形での貢献を歓迎します。